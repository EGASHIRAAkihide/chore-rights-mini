# ChoreRights Test Plan (MVP / PoC)

**Version:** 1.0  
**Date:** 2025-10-16  
**Owner:** QA & Engineering (ChoreRights)

---

## 1. Purpose & Scope

This document defines the **test strategy, scope, environment, and acceptance criteria** for the ChoreRights MVP used in the PoC (2025Q4–2026Q1).  
Coverage spans **unit, integration, E2E, performance, security, and compliance** tests across the core flows:

1. **Registration**: Creator registers choreography, ICC is generated, fingerprint stored, on-chain proof minted (PoC: mock or real).
2. **Licensing**: Licensee requests a license → Creator approves/rejects → Agreement issued → (optional) on-chain record.
3. **Royalty Records**: Payments are recorded and distribution is simulated.
4. **Admin & KPI**: KPI dashboard aggregates events and exports CSV.

---

## 2. Test Objectives

- Validate **functional correctness** of MVP flows under RLS (Supabase).
- Ensure **API contracts** conform to `/docs/design/api_contracts.md`.
- Establish **stability** (≥99.5% API uptime during PoC) and **data integrity**.
- Verify **security** (authZ via RLS, no PII leakage on-chain) and **privacy** controls.
- Provide **evidence** for legal and investor stakeholders (logs, reports, traceability).

---

## 3. Out of Scope

- Production-scale performance (>1k concurrent users)
- Automated fiat settlement (Stripe live mode)
- Cross-jurisdiction copyright enforcement

---

## 4. Test Environment

| Layer      | Configuration                              | Notes                              |
| ---------- | ------------------------------------------ | ---------------------------------- |
| Frontend   | Next.js 14 (Vercel for prod / local dev)   | App Router, TypeScript             |
| Backend    | Supabase Cloud (Postgres + Auth + Storage) | RLS enabled, logs available        |
| Blockchain | Polygon Mumbai (Alchemy RPC)               | Testnet; can be mocked in CI       |
| AI         | AWS Rekognition Custom Labels              | PoC accuracy ≥90% (can be stubbed) |
| CI         | GitHub Actions                             | Headless Playwright, Node 20       |
| Browsers   | Chromium (default), WebKit/Firefox (smoke) | Mobile viewport smoke optional     |

**Secrets** are injected via CI and `.env.test.local`. No secrets in repo.

---

## 5. Test Data & Seeding

- **Users**
  - `creator@test.local` (role=creator)
  - `licensee@test.local` (role=licensee)
  - `admin@test.local` (role=admin)

- **Seeding script / E2E helper**
  - `POST /api/test/set-auth` to create SSR session (non-prod only).
  - SQL seed for reference tables (tariffs, license templates) when needed.
  - Minimal **works** and **fingerprints** data generated by the E2E on demand.

- **Data reset policy**
  - Nightly reset for shared QA env; per-test teardown for CI.

---

## 6. Test Types & Tools

| Type                | Tool                           | Focus                                     |
| ------------------- | ------------------------------ | ----------------------------------------- |
| Unit                | Vitest                         | Pure functions (tariff calc, zod schemas) |
| Integration         | Supabase RPC + Node tests      | DB DDL/RLS policies, triggers, migrations |
| E2E                 | Playwright                     | End-to-end happy path & error handling    |
| API Contract        | OpenAPI + Supertest (optional) | Request/response schema conformance       |
| Performance (light) | Artillery / k6 (optional)      | `/api/works/register` p95 < 300ms         |
| Security            | ZAP/Burp (manual) + checklists | AuthZ via RLS, IDOR, secrets handling     |
| Accessibility       | axe-core (CI)                  | WCAG AA for core screens                  |
| Compliance          | Manual checklist               | PII & on-chain data separation            |

---

## 7. Test Coverage Matrix

### 7.1 Functional (Core Flows)

| ID       | Area         | Scenario                                             | Priority |
| -------- | ------------ | ---------------------------------------------------- | -------- |
| F-REG-01 | Registration | Upload video + metadata + ICC validation             | High     |
| F-REG-02 | Registration | Fingerprint persisted; hash auto-fill trigger        | High     |
| F-REG-03 | Registration | On-chain authorship proof (mock real TX)             | Medium   |
| F-LIC-01 | License      | Licensee submits request (territory/duration/media)  | High     |
| F-LIC-02 | License      | Creator approves request → Agreement created         | High     |
| F-LIC-03 | License      | Creator rejects request (audit log)                  | Medium   |
| F-AGR-01 | Agreement    | Sign by both parties; finalize (polygon tx optional) | High     |
| F-PAY-01 | Payment      | Record payment; simulate distribution 70/30          | Medium   |
| F-ADM-01 | Admin/KPI    | KPI aggregates; CSV export endpoint                  | High     |

### 7.2 RLS & Security

| ID         | Scenario                                      | Expected          |
| ---------- | --------------------------------------------- | ----------------- |
| SEC-RLS-01 | Creator cannot read others’ `works`           | 403 RLS_DENIED    |
| SEC-RLS-02 | Licensee cannot access unrelated `agreements` | 403 RLS_DENIED    |
| SEC-RLS-03 | Admin-only KPI                                | 403 for non-admin |

### 7.3 Error & Resilience

| ID         | Scenario                   | Expected                     |
| ---------- | -------------------------- | ---------------------------- |
| ERR-VAL-01 | Invalid ICC format         | 400 VALIDATION_ERROR         |
| ERR-BIZ-01 | Overlapping license period | 422 BUSINESS_RULE            |
| ERR-UP-01  | Polygon RPC down           | 502 UPSTREAM + retry/backoff |

### 7.4 Non-Functional

| ID           | Scenario                  | Target                  |
| ------------ | ------------------------- | ----------------------- |
| NFR-PERF-01  | `/api/works/register` p95 | < 300ms (CI light load) |
| NFR-AVAIL-01 | API uptime during PoC     | ≥ 99.5%                 |
| NFR-AX-01    | Accessibility checks      | No critical violations  |

---

## 8. E2E Test Design (Playwright)

### 8.1 Selectors (data-testid)

- Registration page:
  - `work-title`, `work-desc`, `work-video`, `icc-country`, `icc-registrant`, `icc-serial`, `submit-register`
- Work details:
  - `icc-code`, `fingerprint-hash`, `polygon-tx`
- License request:
  - `req-usage`, `req-territories`, `req-duration`, `req-media`, `req-submit`
- Approval screen:
  - `approve-btn`, `reject-btn`
- Agreement screen:
  - `agreement-status`, `finalize-btn`, `tx-hash`
- KPI:
  - `kpi-table`, `export-csv`

> **Note:** E2E should **log last REST/Storage/RPC responses** when a wait fails to aid debugging.

### 8.2 Happy Path Scenario

```text
1) Creator login (via /api/test/set-auth)
2) Register work → assert icc-code & fingerprint-hash shown
3) Open work page → verify status ACTIVE
4) Licensee login → submit license request (req-usage visible)
5) Creator login → approve request → agreement created
6) Sign & finalize → agreement-status=FINALIZED & tx-hash exists
7) Admin login → KPI shows counts; export CSV works

8.3 Negative Tests
	•	Registration without termsAccepted → 400
	•	License request with invalid durationDays → 400
	•	License approve by non-owner → 403
	•	Access /admin/kpi as non-admin → 403

8.4 Sample Code (excerpt)

/tests/e2e/smoke.spec.ts

test('smoke: register → request → approve → finalize', async ({ page }) => {
  // Creator session
  await page.request.post('/api/test/set-auth', { data: { email: 'creator@test.local', role: 'creator' } });
  await page.goto('/dashboard/new');
  await page.getByTestId('work-title').fill('Wave Motion 2025');
  await page.getByTestId('work-video').setInputFiles('tests/fixtures/wave.mp4');
  await page.getByTestId('icc-country').fill('JP');
  await page.getByTestId('icc-registrant').fill('CRG');
  await page.getByTestId('icc-serial').fill('000001');
  await page.getByTestId('submit-register').click();
  await expect(page.getByTestId('icc-code')).toBeVisible(); // e.g., JP-CRG-000001

  // Licensee session
  await page.request.post('/api/test/set-auth', { data: { email: 'licensee@test.local', role: 'licensee' } });
  await page.goto(`/works`);
  await page.getByTestId('req-usage').click();
  // ... fill form & submit; then check approval flow similarly
});


⸻

9. API Contract Tests
	•	Validate request/response schema using Zod/OpenAPI snapshots.
	•	Enforce error model (VALIDATION_ERROR, RLS_DENIED, BUSINESS_RULE, UPSTREAM).
	•	Deterministic quote from POST /api/license/calculate must match tariff table.

⸻

10. Database & Migration Tests
	•	Idempotency: All migrations must pass scripts/verify-migration-idempotent.ts.
	•	RLS: Attempt reads/writes with mismatched JWT; expect 403.
	•	Triggers: fingerprints hash auto-fill when only vector provided.
	•	Views/RPC: aggregate_kpi_daily() produces expected rows.

⸻

11. Performance & Reliability (Lightweight)
	•	Smoke perf on /api/works/register with 10 RPS for 1 min.
	•	Assert p95 < 300ms and no error rate > 1%.
	•	Backoff logic is exercised when Polygon RPC returns 5xx.

⸻

12. Security & Privacy
	•	AuthN/Z: Validate JWT required on all mutating routes; RLS enforced.
	•	PII: No emails or real names on-chain; logs redact sensitive data.
	•	Headers: Strict-Transport-Security, Content-Security-Policy checks in prod.
	•	Rate Limit: 100 req/min/user; verify 429 when exceeded (mock).

⸻

13. Accessibility
	•	Run axe-core audit on major pages: /, /dashboard/new, /admin/kpi.
	•	No critical violations (color contrast, aria roles, label/input pairing).

⸻

14. Bug Lifecycle & Triage

Severity	Impact	Example
S1	Blocking core flow	Registration fails or RLS leaks data
S2	Major feature broken	Approval cannot create agreements
S3	Minor functional	Misaligned UI, wrong copy
S4	Cosmetic/Docs	Typos, spacing

SLA Targets (PoC):
	•	S1: 24h fix; S2: 72h; S3: Next sprint; S4: Backlog.

⸻

15. Reporting & Evidence
	•	CI artifacts: Playwright traces, screenshots, videos.
	•	KPI export CSV attached to release candidate.
	•	Test run summary (pass/fail, defects) stored in /docs/testing/results/YYYY-MM-DD.md.

⸻

16. Entry/Exit Criteria

Entry
	•	Migrations applied (pnpm db:push)
	•	Secrets configured for test env
	•	E2E helpers enabled (/api/test/set-auth)

Exit (Release Candidate)
	•	E2E happy path 100% pass
	•	No open S1/S2 defects
	•	KPI dashboard renders, CSV export works
	•	Security/RLS checks passed
	•	Docs updated (API, Data Model)

⸻

17. Schedule & Responsibilities

Phase	Owner	Output
Test Planning	QA Lead	This document
Env Setup	DevOps	CI pipelines, secrets
Test Authoring	QA/Eng	Unit/Int/E2E specs
Execution	QA/Eng	CI runs, traces
Reporting	PM/QA	Summary + action items


⸻

18. Change Log
	•	1.0 (2025-10-16) Initial MVP PoC test plan covering functional, RLS, API contracts, KPI, and basic perf/security.
```
